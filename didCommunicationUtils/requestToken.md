![logo](https://avatars.githubusercontent.com/u/57396025?s=200&v=4)

# [**JWT-secured authorisation request (JAR) with DIDComm envelope**](./README.md)

## **OpenID authorization code grant - DIDComm envelope**

### **Creating a compact JWT/DIDComm message for the Access Token Request Form**

#### **Payload of a JWS/jar-didcomm-signed+json message**

The payload of the JWS/DIDComm signed message requires Proof Key for Code Exchange (PKCE, pronounced "pixy") as security extension to OAuth 2.0 for public clients on mobile devices, designed to prevent interception of the authorisation code by a malicious app that has sneaked into the same device. It is mandatory in OAuth 2.1.

An OpenID Code JAR receives from a client app a randomly self-generated "code_challenge" as part of the OAuth 2.0 Authorization Request.

As per the Financial-grade API Security ([FAPI 1.0 Advanced - Section 5.2.2: Authorization Server](https://openid.net/specs/openid-financial-api-part-2-1_0-final.html#authorization-server) and [FAPI 2.0 Security Profile - Section 4.3.1.2: Authorization Code Flow](https://openid.bitbucket.io/fapi/fapi-2_0-security.html#section-4.3.1.2) and the DIDComm specification, the JWT payload ([request object, RFC9101](https://www.rfc-editor.org/rfc/rfc9101.html#section-2.1)))
requires the following:

- the **"type"** (*required in UHC*) field is set in UHC as *"code+jar"* to predict the content of the message.
- the **"scope"** (*required*) field value is *"openid"*.
- the **"response_type"** (*required*) field value contains *"code"*.
- the **"response_mode"** (*required*) field value is *"jwt"* (to get the default "query.jwt" redirect URL format) or *"form_post.jwt"*, **recommended in UHC**.
- the **"code"** (*required*) field is the code previously generated by the */authorize* endpoint.
- the **"nbf"** (*required*) field is no longer than *60 minutes* in the past (JSON numeric value representing the number of seconds from the UNIX epoch).
- the **"exp"** (*required*) TODO
- the **"iss"** (*required*) field is the *"client_id"* of the OAuth Client (*private_key_jwt* authentication method as specified in *section 9 of OIDC*).
- the **"client_id"** (*required*) identifies in UHC the identifier of the cryptographic signature key (DID#kid URI) of the profile sending the request. In UHC, it is the Dilithium JWK thumbprint of a wallet's profile (e.g.: the key ID of the wallet of an employee who performs a role in a department, of a patient or patient's related person, of a patient's medical device, of a department's medical device).

  *Examples:*

  `did:legal:health:ES::::Organization:uuid:e7f01da5-7cd4-4e7c-993f-f83659684a94:Department:uuid:9fa1c633-a3df-4cc8-bbb7-6f1bb2775c89:Practitioner:uuid:ed8206a7-1623-4b07-863a-3a8bc049fe05:PractitionerRole:type:Supervisor#${EmployeeProfileDilithiumKid}`

  *or*

  `did:legal:health:ES::::Organization:uuid:e7f01da5-7cd4-4e7c-993f-f83659684a94:HealthcareService:uuid:097c1d6c-4622-4511-a908-4417edda459c:Practitioner:uuid:77166e58-d08b-42b8-8370-480f82feded3:PractitionerRole:HL7:MD#${EmployeeProfileDilithiumKid}`


- the **"subject"** (*required*) field refers in UHC to the target practitioner's DID when an admin is creating an install-code for a practitioner's profile (rather than referring to the cryptographic identifier "client_id" of the requester).

  *Example:*

  `did:legal:health:ES::::Organization:uuid:e7f01da5-7cd4-4e7c-993f-f83659684a94:Practitioner:uuid:ed8206a7-1623-4b07-863a-3a8bc049fe05`

- the **"aud"** (*required*) in UHC identifies at the same time the *"software_id"* URL and the OP's Issuer Identifier URL as the intended audience. The Authorization Server MUST verify that it is an intended audience.

  *Examples:*

  `https://identity.professional.organization-name.hospital.app`

  `https://connections.professional.organization-name.hospital.app`

- the **"jti"** (*required*) field is a unique identifier for the JWT (*JWT ID*), which can be used to prevent reuse of the request (replay attacks).
- the **"redirect_url"** (*optional*):

*Notes*:
1) *the "id" field (required in DIDComm) is ignored in UHC because "jti" is used for back-guard compatibility with OpenID.*
2) *the "body" field (required in DIDComm) can have protocol and application-level data as per the DIDComm specification, but it is ignored in UHC for a "code" request.*
