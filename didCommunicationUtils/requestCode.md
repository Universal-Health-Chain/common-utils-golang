![logo](https://avatars.githubusercontent.com/u/57396025?s=200&v=4)

# [**JWT-secured authorisation request (JAR) with DIDComm envelope**](./README.md)

## **OpenID authorization code grant - DIDComm envelope**

### **Creating a compact JWT/DIDComm for the Authorization Code Request Form**

#### **Payload of the JWS/jar-didcomm-signed+json message**

The payload of the JWS/DIDComm signed message requires Proof Key for Code Exchange (PKCE, pronounced "pixy") as security extension to OAuth 2.0 for public clients on mobile devices, designed to prevent interception of the authorisation code by a malicious app that has sneaked into the same device. It is mandatory in OAuth 2.1.

An OpenID Code JAR receives from a client app a randomly self-generated "code_challenge" as part of the OAuth 2.0 Authorization Request.

As per the Financial-grade API Security ([FAPI 1.0 Advanced - Section 5.2.2: Authorization Server](https://openid.net/specs/openid-financial-api-part-2-1_0-final.html#authorization-server) and [FAPI 2.0 Security Profile - Section 4.3.1.2: Authorization Code Flow](https://openid.bitbucket.io/fapi/fapi-2_0-security.html#section-4.3.1.2) and the DIDComm specification, the JWT payload ([request object, RFC9101](https://www.rfc-editor.org/rfc/rfc9101.html#section-2.1)))
requires the following:

*Note: the "id" field (required in DIDComm) is ignored in UHC because "jti" is used for back-guard compatibility with OpenID*

- the **"type"** (*required in UHC*) field is set in UHC as *"login-code+jar"* or *"profile-code+jar"* to predict the content of the message.
- the **"body"** (*conditional*) field can have protocol and application-level data as per the DIDComm specification, it is ignored by UHC in a *"code+jar"* message type, but it can be used in a *"profile-code+jar"* request to encrypt the access token of the admin user creating a new code for an employee profile (client app). 
- the **"aud"** (*required for FAPI*) property in the request object (it can be the same as the "aud" in an access token) is in UHC the URL of the issuer's service for the client app (a resolved DID fragment contains the full URL but not just the issuer URL). The URL of the issuer's service identifies at the same time the *"software_id"* URL and the OP's Issuer Identifier URL as the intended audience. The final endpoint MUST verify that it is an intended audience.
  
  *Examples:*

  `https://identity.professional.organization-name.hospital.app` for `did:legal:health:ES::::Organization:uuid:e7f01da5-7cd4-4e7c-993f-f83659684a94?service=professional-login-authorization`
  `https://connections.professional.organization-name.hospital.app` for `did:legal:health:ES::::Organization:uuid:e7f01da5-7cd4-4e7c-993f-f83659684a94?service=professional-connection-authorization`

- the **"scope"** (*required*) field value contains *"openid"*. Additionally, when an admin is creating a new profile for an employee, more permissions can be included in the "scope" field by using the [SMART-On-FHIR v2 permissions format](https://www.hl7.org/fhir/smart-app-launch/scopes-and-launch-context.html#scopes-for-requesting-clinical-data).
- the **"response_type"** (*required*) field value contains *"code"*.
- the **"response_mode"** (*required*) field value is *"jwt"* (to get the default "query.jwt" redirect URL format) or *"form_post.jwt"*, **recommended in UHC**.
- the **"code_challenge_method"** (*required*) field value is *"S256"*.
- the **"code_challenge"** (*required*) field is the *SHA-256* hash result of a random challenge generated by the client application, base64url encoded.
- the **"nbf"** (*required*) field is no longer than *60 minutes* in the past (JSON numeric value representing the number of seconds from the UNIX epoch).
- the **"exp"** (*required*) field has a lifetime of no longer than *60 minutes* after the *"nbf"* field (JSON numeric value representing the number of seconds from the UNIX epoch).

    NOTE: Set the validity period of the authorization code (expiration) to one minute or a suitable short period of time if not replay is possible. The validity period may act as a cache control indicator of when to clear the authorization code cache if one is used ([FAPI 2.0 Baseline Profile - Section 2.2.1 - second note](https://openid.net/specs/fapi-2_0-baseline.html#section-2.2.1)). 

    When an admin is creating an install-code for a practitioner profile, a custom expiration can be established (between 1-60 minutes).

- the **"client_id"** (*required*) is used in to identify the client app's reverse-DNS as software ID.
- the **"subject"** (*required*) field refers in UHC to the target practitioner's DID (for login-code or a new install-code for a practitioner's profile, rather than referring to the Client software application ID ("client_id").

  *Example:*

  `did:legal:health:ES::::Organization:uuid:e7f01da5-7cd4-4e7c-993f-f83659684a94:Practitioner:uuid:ed8206a7-1623-4b07-863a-3a8bc049fe05`


- the **"jti"** (*required*) field is a unique identifier for the JWT (*JWT ID*), which can be used to prevent reuse of the request (replay attacks).
- the **"redirect_url"** (*optional*):

*Notes*:
1) *the "id" field (required in DIDComm) is ignored in UHC because "jti" is used for back-guard compatibility with OpenID.*
2) *the "iss" property is not used in a JAR.*